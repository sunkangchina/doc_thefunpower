<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>数据库 | thefunpower开发包</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.73d0500b.css" as="style"><link rel="preload" href="/assets/js/app.e6271c43.js" as="script"><link rel="preload" href="/assets/js/2.63c13255.js" as="script"><link rel="preload" href="/assets/js/15.f492c4fe.js" as="script"><link rel="prefetch" href="/assets/js/10.9f361f6a.js"><link rel="prefetch" href="/assets/js/11.ac387f0d.js"><link rel="prefetch" href="/assets/js/12.dfbdb728.js"><link rel="prefetch" href="/assets/js/13.91fa5cd3.js"><link rel="prefetch" href="/assets/js/14.81db091e.js"><link rel="prefetch" href="/assets/js/16.a6e8ad33.js"><link rel="prefetch" href="/assets/js/17.96998458.js"><link rel="prefetch" href="/assets/js/18.50a55ccf.js"><link rel="prefetch" href="/assets/js/19.07490f6d.js"><link rel="prefetch" href="/assets/js/20.827e00ba.js"><link rel="prefetch" href="/assets/js/21.c39bbb64.js"><link rel="prefetch" href="/assets/js/3.869cf45f.js"><link rel="prefetch" href="/assets/js/4.832274fd.js"><link rel="prefetch" href="/assets/js/5.e457cf98.js"><link rel="prefetch" href="/assets/js/6.8d81f0ec.js"><link rel="prefetch" href="/assets/js/7.159f2f50.js"><link rel="prefetch" href="/assets/js/8.827714f8.js"><link rel="prefetch" href="/assets/js/9.6a63ad8e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.73d0500b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">thefunpower开发包</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  手册
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  手册
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>开发手册</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/" aria-current="page" class="sidebar-link">入门</a></li><li><a href="/guide/fun.html" class="sidebar-link">函数</a></li><li><a href="/guide/database.html" aria-current="page" class="active sidebar-link">数据库</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/database.html#sql查寻" class="sidebar-link">SQL查寻</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#取最小值" class="sidebar-link">取最小值</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#取最大值" class="sidebar-link">取最大值</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#总数" class="sidebar-link">总数</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#是否有记录" class="sidebar-link">是否有记录</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#随机取多条记录" class="sidebar-link">随机取多条记录</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#取总和" class="sidebar-link">取总和</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#取平均值" class="sidebar-link">取平均值</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#返回数据库允许的数据-传入其他字段自动忽略" class="sidebar-link">返回数据库允许的数据，传入其他字段自动忽略</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#查寻多条记录" class="sidebar-link">查寻多条记录</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#查一条数据" class="sidebar-link">查一条数据</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#更新记录" class="sidebar-link">更新记录</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#删除记录" class="sidebar-link">删除记录</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#动作事件" class="sidebar-link">动作事件</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#事务" class="sidebar-link">事务</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#分页" class="sidebar-link">分页</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#完整演示" class="sidebar-link">完整演示</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#获取数据库结构" class="sidebar-link">获取数据库结构</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#非当前数据库结构" class="sidebar-link">非当前数据库结构</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#markdown格式" class="sidebar-link">markdown格式</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#markdown转html" class="sidebar-link">markdown转html</a></li><li class="sidebar-sub-header"><a href="/guide/database.html#数据表及字段" class="sidebar-link">数据表及字段</a></li></ul></li><li><a href="/guide/vue.html" class="sidebar-link">Vue类</a></li><li><a href="/guide/validate.html" class="sidebar-link">数据验证</a></li><li><a href="/guide/aes.html" class="sidebar-link">加密解密</a></li><li><a href="/guide/plugin_upgrade.html" class="sidebar-link">插件</a></li><li><a href="/guide/cmd.html" class="sidebar-link">命令行</a></li><li><a href="/guide/sortable.html" class="sidebar-link">sortable</a></li><li><a href="/guide/composer.html" class="sidebar-link">composer</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="数据库"><a href="#数据库" class="header-anchor">#</a> 数据库</h1> <p>数据库操作是对Medoo Version: 2.1.7进行再封装，让操作更方便。</p> <p>在使用前需要对Medoo 数据库类有足够的了解，否则有可能无法理解参数传递等问题。</p> <h2 id="sql查寻"><a href="#sql查寻" class="header-anchor">#</a> SQL查寻</h2> <div class="language- extra-class"><pre class="language-text"><code>db_query($sql, $raw = null)
</code></pre></div><h2 id="取最小值"><a href="#取最小值" class="header-anchor">#</a> 取最小值</h2> <div class="language- extra-class"><pre class="language-text"><code>db_get_min($table, $join  = &quot;*&quot;, $column = null, $where = null)
</code></pre></div><h2 id="取最大值"><a href="#取最大值" class="header-anchor">#</a> 取最大值</h2> <div class="language- extra-class"><pre class="language-text"><code>db_get_max($table, $join =  &quot;*&quot;, $column = null, $where = null)
</code></pre></div><h2 id="总数"><a href="#总数" class="header-anchor">#</a> 总数</h2> <div class="language- extra-class"><pre class="language-text"><code>db_get_count($table, $join =  &quot;*&quot;, $column = null, $where = null)
</code></pre></div><h2 id="是否有记录"><a href="#是否有记录" class="header-anchor">#</a> 是否有记录</h2> <div class="language- extra-class"><pre class="language-text"><code>db_get_has($table, $join = null, $where = null)
</code></pre></div><h2 id="随机取多条记录"><a href="#随机取多条记录" class="header-anchor">#</a> 随机取多条记录</h2> <div class="language- extra-class"><pre class="language-text"><code>db_get_rand($table, $join = &quot;*&quot;, $column = null, $where = null)
</code></pre></div><h2 id="取总和"><a href="#取总和" class="header-anchor">#</a> 取总和</h2> <div class="language- extra-class"><pre class="language-text"><code>db_get_sum($table, $join = &quot;*&quot;, $column = null, $where = null)
</code></pre></div><h2 id="取平均值"><a href="#取平均值" class="header-anchor">#</a> 取平均值</h2> <div class="language- extra-class"><pre class="language-text"><code>db_get_avg($table, $join = &quot;*&quot;, $column = null, $where = null)
</code></pre></div><h2 id="返回数据库允许的数据-传入其他字段自动忽略"><a href="#返回数据库允许的数据-传入其他字段自动忽略" class="header-anchor">#</a> 返回数据库允许的数据，传入其他字段自动忽略</h2> <div class="language- extra-class"><pre class="language-text"><code>db_allow($table, $data)
</code></pre></div><h2 id="查寻多条记录"><a href="#查寻多条记录" class="header-anchor">#</a> 查寻多条记录</h2> <div class="language- extra-class"><pre class="language-text"><code>$data = db()-&gt;select(&quot;account&quot;, [
	&quot;user_name&quot;,
	&quot;email&quot;
	], [
	&quot;user_id[&gt;]&quot; =&gt; 100
]);
</code></pre></div><p><code>db()-&gt;select</code> 等价于 <code>db_get()</code></p> <h2 id="查一条数据"><a href="#查一条数据" class="header-anchor">#</a> 查一条数据</h2> <div class="language- extra-class"><pre class="language-text"><code>$res = db_get_one(&quot;drop_account&quot;,&quot;*&quot;,['id'=&gt;$id]);  
</code></pre></div><h2 id="更新记录"><a href="#更新记录" class="header-anchor">#</a> 更新记录</h2> <div class="language- extra-class"><pre class="language-text"><code>db_update(&quot;drop_account&quot;,[
          'status'=&gt;$status,
          'updated_at'=&gt;now(),
          'admin_user_id'=&gt;get_admin_id(),
],['id'=&gt;$id]); 
</code></pre></div><h2 id="删除记录"><a href="#删除记录" class="header-anchor">#</a> 删除记录</h2> <div class="language- extra-class"><pre class="language-text"><code>db_del($table, $where)
</code></pre></div><h2 id="动作事件"><a href="#动作事件" class="header-anchor">#</a> 动作事件</h2> <div class="language- extra-class"><pre class="language-text"><code>do_action(&quot;db_insert.$table.before&quot;, $data);	添加数据前	
do_action(&quot;db_insert.$table.after&quot;, $action_data);	添加数据后 db_insert时触发	$action_data = [];
$action_data['id'] = $id;
$action_data['data'] = $data;
do_action(&quot;db_update.$table.before&quot;, $data);	更新数据前 db_insert时触发	 
do_action(&quot;db_update.$table.after&quot;, $action_data);	更新数据后  db_update时触发	$action_data = [];
$action_data['where'] = $where;
$action_data['data'] = $data;
do_action(&quot;db_get_one.$table&quot;, $one);	查寻一条记录 db_get_one时触发	
do_action(&quot;db_get.$table&quot;, $all);	查寻多条记录 db_get时触发	
do_action(&quot;db_insert.$table.del&quot;, $where);	删除记录 db_del($table, $where)时触发	
do_action(&quot;db_query&quot;, $all);	db_query时触发	
</code></pre></div><p>更多可查看源码</p> <h2 id="事务"><a href="#事务" class="header-anchor">#</a> 事务</h2> <div class="language- extra-class"><pre class="language-text"><code>db_action(function(){
   //如果有return false;就会回滚
});
</code></pre></div><h2 id="分页"><a href="#分页" class="header-anchor">#</a> 分页</h2> <div class="language- extra-class"><pre class="language-text"><code>db_pager(&quot;drop_account&quot;,&quot;*&quot;,$where); 
</code></pre></div><h2 id="完整演示"><a href="#完整演示" class="header-anchor">#</a> 完整演示</h2> <div class="language- extra-class"><pre class="language-text"><code>include __DIR__.'/../../../../app.php'; 
//注销帐号.管理
access('drop_account.admin');

$wq = g(&quot;wq&quot;);
$where = [
  'ORDER'=&gt;[
    'id'=&gt;'DESC'
  ], 
];  
if($wq){
  $where[&quot;phone[~]&quot;] = $wq;
}   
$where['status'] = $input['status']?:0; 
$data = db_pager(&quot;drop_account&quot;,&quot;*&quot;,$where); 
$list = [];
foreach($data['data'] as &amp;$v){   
} 
json($data);
</code></pre></div><p>分页table</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;?php   
/*
	Copyright (c) 2021-2050 FatPlug, All rights reserved.
	This file is part of the FatPlug Framework (http://fatplug.cn).
	This is not free software.
	you can redistribute it and/or modify it under the
	terms of the License after purchased commercial license. 
	mail: sunkangchina@163.com
	web: http://fatplug.cn
*/
global $config; 
$config['title'] = &quot;注销帐号&quot;;
include __DIR__.'/../../app.php';      
admin_header(); 
check_admin_login();
$vue = new Vue;  
$vue-&gt;opt = [
    'is_page'  =&gt; true,
    'is_reset' =&gt; false,
    'is_add'   =&gt; false,
    'is_edit'  =&gt; false, 
];
$vue-&gt;page_url = &quot;/plugins/drop_account/api/admin/drop_account.php&quot;;  
$vue-&gt;data(&quot;activeName&quot;,&quot;0&quot;); 
$vue-&gt;data(&quot;height&quot;,&quot;&quot;); 
$vue-&gt;created([&quot;start()&quot;]);
$vue-&gt;method(&quot;start()&quot;,&quot;js: 
	this.fn();
	if (window.addEventListener) {
	    window.addEventListener('resize', function() {
	      app.fn();
	    });
	} else if (window.attachEvent) {
	    window.attachEvent('onresize', function() {
	      app.fn();
	    });
	} 
&quot;);
$vue-&gt;method(&quot;fn()&quot;,&quot;js:
this.height = window.innerHeight-180;
&quot;);


$vue-&gt;data(&quot;ch&quot;,&quot;js:[]&quot;);
$vue-&gt;method(&quot;handleClick()&quot;,&quot;js: 
	this.where.status = this.activeName; 
	this.where.page = 1;
	this.load();
&quot;);

$vue-&gt;method(&quot;confirm(row,status)&quot;,&quot;js: 
	let id = row.id;
	let txt = '确认拒绝该操作吗？';
	let by = '拒绝后用户还可以再次发起注销申请,&lt;br&gt;此操作不会注销用户，可放心操作';
	let cf = '确认拒绝';
	if(status==1){
		txt = '确认注销该帐号吗？';
		by = '&lt;span style=\&quot;color:red;\&quot;&gt;该操作次注销用户所有相关数据包含但不限：&lt;br&gt;用户基础信息（头像、昵称、手机号等）、订单信息、会员信息等。&lt;br&gt;请确认好再操作，该操作不可逆！！！&lt;/span&gt;';
		cf = '确认注销帐号';
	}
	layer.confirm(txt, {
	  title:'操作提醒',
	  content:'帐号：'+row.phone+'&lt;br&gt;'+by,
	  btn: [cf,'取消'] //按钮
	}, function(){
		layer.load();
	  	ajax('/plugins/drop_account/api/admin/drop_account_confirm.php',{
	  		id:id,
	  		status:status
	  	},function(){
	  		layer.closeAll();
	  		_this.load();
	  		_this.\$message({
	  			type:res.type,
	  			message:res.msg, 
	  		});
	  	});
	}, function(){
	   layer.closeAll();
	});
	 
&quot;);


 

$js  = $vue-&gt;run(); 
?&gt;
 
&lt;div id=&quot;app&quot;  v-cloak&gt;   
	  &lt;div class=&quot;main_body&quot;&gt; 
		  &lt;el-tabs v-model=&quot;activeName&quot; @tab-click=&quot;handleClick&quot; &gt;
		    &lt;el-tab-pane label=&quot;待审核&quot; name=&quot;0&quot;&gt; 
		    	&lt;?php include __DIR__.'/_table.php';?&gt;
		    &lt;/el-tab-pane&gt;
		    &lt;el-tab-pane label=&quot;已注销&quot; name=&quot;1&quot; &gt;
		    	 &lt;?php include __DIR__.'/_table.php';?&gt;
		    &lt;/el-tab-pane&gt; 
		    &lt;el-tab-pane label=&quot;已拒绝&quot; name=&quot;-1&quot; &gt;
		    	 &lt;?php include __DIR__.'/_table.php';?&gt;
		    &lt;/el-tab-pane&gt; 
		  &lt;/el-tabs&gt;  
	      &lt;p&gt;
	    	&lt;el-pagination background class=&quot;mt10&quot;  
		      @size-change=&quot;page_size_change&quot;
		      @current-change=&quot;page_change&quot;
		      :current-page=&quot;page&quot;
		      :page-sizes=&quot;[20,50,100,500,1000]&quot;
		      :page_size=&quot;where.pre_page&quot;
		      layout=&quot;total, sizes, prev, pager, next, jumper&quot;
		      :total=&quot;total&quot;&gt;
		    &lt;/el-pagination&gt; 
		&lt;/p&gt;
    &lt;/div&gt; 
     


&lt;/div&gt;

&lt;script type=&quot;text/javascript&quot;&gt;
	&lt;?= $js?&gt; 
&lt;/script&gt;
&lt;?php 
admin_footer();
?&gt;
</code></pre></div><p>_table.php 内容</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;?php if(!defined(&quot;PATH&quot;)){exit();}?&gt;
&lt;el-table  border    :height=&quot;height&quot;
  :data=&quot;lists&quot;
  style=&quot;width: 100%&quot;&gt; 
  &lt;el-table-column 
    prop=&quot;phone&quot;
    label=&quot;帐号&quot;
    width=&quot;&quot;&gt;
  &lt;/el-table-column&gt;  
  &lt;el-table-column 
    prop=&quot;user_id&quot;
    label=&quot;用户ID&quot;
    width=&quot;100&quot;&gt;
  &lt;/el-table-column&gt; 
  &lt;el-table-column 
    prop=&quot;created_at&quot;
    label=&quot;申请时间&quot;
    width=&quot;180&quot;&gt;
  &lt;/el-table-column&gt; 
  &lt;el-table-column
    prop=&quot;updated_at&quot;
    label=&quot;审核时间&quot;
    width=&quot;180&quot;&gt;
  &lt;/el-table-column&gt; 
  &lt;el-table-column v-if=&quot;activeName == 0&quot;
    prop=&quot;comment&quot;
    label=&quot;操作&quot;
    width=&quot;180&quot;&gt;
    &lt;template slot-scope=&quot;scope&quot;&gt; 
      &lt;div v-if=&quot;scope.row.status==0&quot;&gt;
         &lt;a href=&quot;javascript:void(0);&quot;  @click=&quot;confirm(scope.row,1)&quot; class=&quot;link hand&quot;  &gt;确认注销&lt;/a&gt;
         &lt;a href=&quot;javascript:void(0);&quot;  @click=&quot;confirm(scope.row,-1)&quot; class=&quot;link hand ml20&quot;&gt;拒绝注销&lt;/a&gt;
      &lt;/div&gt; 
    &lt;/template&gt;  
  &lt;/el-table-column&gt;   
&lt;/el-table&gt;  
</code></pre></div><h2 id="获取数据库结构"><a href="#获取数据库结构" class="header-anchor">#</a> 获取数据库结构</h2> <p>数组</p> <div class="language- extra-class"><pre class="language-text"><code>database_tables()
</code></pre></div><h2 id="非当前数据库结构"><a href="#非当前数据库结构" class="header-anchor">#</a> 非当前数据库结构</h2> <div class="language- extra-class"><pre class="language-text"><code>database_tables($database_name)
</code></pre></div><h2 id="markdown格式"><a href="#markdown格式" class="header-anchor">#</a> markdown格式</h2> <p>在config.ini.php中配置的数据库链接信息必须同时拥有$database_name权限
markdown格式</p> <div class="language- extra-class"><pre class="language-text"><code>pr(database_tables(null,true));
</code></pre></div><p>返回结果：</p> <div class="language- extra-class"><pre class="language-text"><code>upload 上传文件

| 字段  |  类型 | 备注|
| ------------ | ------------ |------------ |
|  id |  int(11) |主键|
|  url |  varchar(255) |URL|
|  hash |  varchar(255) |唯一值|
|  user_id |  int(11) |用户ID|
|  mime |  varchar(255) |类型|
|  size |  decimal(20,2) |大小|
|  ext |  varchar(10) |后缀|
|  created_at |  datetime |创建时间|
|  name |  varchar(255) |文件名|
</code></pre></div><h2 id="markdown转html"><a href="#markdown转html" class="header-anchor">#</a> markdown转html</h2> <div class="language- extra-class"><pre class="language-text"><code>echo Parsedown::instance()
  -&gt;setMarkupEscaped(true)
  -&gt;text(database_tables(null,true)); 
</code></pre></div><h2 id="数据表及字段"><a href="#数据表及字段" class="header-anchor">#</a> 数据表及字段</h2> <div class="language- extra-class"><pre class="language-text"><code>$all = database_tables();
$table = [];
foreach($all as $v){
  $table_name = $v['Name'];
  $table[$table_name] = get_table_fields($table_name);
}
pr($table);
</code></pre></div><p>返回</p> <div class="language- extra-class"><pre class="language-text"><code>Array
(
     
    [config] =&gt; Array
        (
            [id] =&gt; id
            [title] =&gt; title
            [body] =&gt; body
        )
)
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/fun.html" class="prev">
        函数
      </a></span> <span class="next"><a href="/guide/vue.html">
        Vue类
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e6271c43.js" defer></script><script src="/assets/js/2.63c13255.js" defer></script><script src="/assets/js/15.f492c4fe.js" defer></script>
  </body>
</html>
